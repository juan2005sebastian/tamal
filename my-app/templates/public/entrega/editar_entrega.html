{% extends 'public/base_cpanel.html' %}

{% block title %}Crud con Python üêç | Editar Entrega{% endblock %}

{% block body %}
<link rel="stylesheet" href="{{ url_for('static', filename ='assets/css/editar.css') }}" />


<div class="card">
  <div class="row justify-content-center mb-2">
    <div class="col-md-12">
      <h3 class="text-center mt-5 mb-4" >
        <a href="/lista-de-entregas" >
          <i class="bi bi-arrow-left-circle" style="font-size: 1.5rem;"></i>
        </a>
        EDITAR ENTREGA
      </h3>
      <hr />
    </div>
  </div>

   <!-- Mensaje de contexto -->
   <div class="context-indicator d-flex align-items-center">
    <i class="bi bi-people-fill context-icon"></i>
    <div>
      <h6 class="mb-1">Vista de editar entregas</h6>
      
    </div>
  </div>

  <div class="row justify-content-center mb-4">
    <div class="col-md-8">
      <div class="card-body p-4" style="background-color: #f8f9fa; border-radius: 10px;">
        <!-- Mostrar mensajes de error -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="alert alert-danger" role="alert">
              {% for category, message in messages %}
                <p>{{ message }}</p>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form action="{{ url_for('viewEditarEntrega', id=entrega_id) }}" method="POST" onsubmit="return validarFormulario()">
          <!-- Campo Tipo de Entrega -->
          <div class="mb-4">
            <label for="tipo" class="form-label" style="font-weight: 600; color: #2c3e50;">
              <i class="bi bi-truck me-2"></i>Tipo de Entrega
            </label>
            <select class="form-select" id="tipo" name="tipo" required style="border-radius: 8px; border: 1px solid #ced4da;">
              <option value="Domicilio" {% if entrega.tipo == 'Domicilio' %}selected{% endif %}>Domicilio</option>
              <option value="Presencial" {% if entrega.tipo == 'Presencial' %}selected{% endif %}>Presencial</option>
            </select>
          </div>

          <!-- Campo Estado de Entrega -->
          <div class="mb-4">
            <label for="estado" class="form-label" style="font-weight: 600; color: #2c3e50;">
              <i class="bi bi-info-circle me-2"></i>Estado de la Entrega
            </label>
            <select class="form-select" id="estado" name="estado" required style="border-radius: 8px; border: 1px solid #ced4da;">
              <option value="Pendiente" {% if entrega.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
              <option value="En Proceso" {% if entrega.estado == 'En Proceso' %}selected{% endif %}>En Proceso</option>
              <option value="En camino" {% if entrega.estado == 'En camino' %}selected{% endif %}>En camino</option>
              <option value="Entregado" {% if entrega.estado == 'Entregado' %}selected{% endif %}>Entregado</option>
            </select>
          </div>
          
          <input type="hidden" name="direccion_id" value="{{ entrega.direccion_id if entrega.direccion_id else '' }}">

          <!-- Campo Costo de Domicilio -->
          <div class="mb-4">
            <label for="costo_domicilio" class="form-label" style="font-weight: 600; color: #2c3e50;">
              <i class="bi bi-cash-coin me-2"></i>Costo de Domicilio
            </label>
            <input type="text" class="form-control" id="costo_domicilio" name="costo_domicilio" value="{{ entrega.costo_domicilio | default('') }}" style="border-radius: 8px; border: 1px solid #ced4da;" oninput="validarCostoDomicilio(this)">
          </div>

          <!-- Campo Usuario (No editable) -->
          <div class="mb-4">
            <label for="nombre_usuario" class="form-label" style="font-weight: 600; color: #2c3e50;">
              <i class="bi bi-person me-2"></i>Usuario
            </label>
            <input 
              type="text" 
              class="form-control" 
              id="nombre_usuario" 
              name="nombre_usuario" 
              value="{{ entrega.nombre_usuario | default('') }}" 
              readonly 
              style="
                border-radius: 8px;
                border: 1px solid #ced4da;
                background-color: #e9ecef;
                color: #495057;
                cursor: not-allowed;
              ">
          </div>

          <!-- Campo Direcci√≥n (No editable) -->
          <div class="mb-4">
            <label for="direccion_completa" class="form-label" style="font-weight: 600; color: #2c3e50;">
              <i class="bi bi-geo-alt me-2"></i>Direcci√≥n Completa
            </label>
            <textarea 
              class="form-control" 
              id="direccion_completa" 
              name="direccion_completa" 
              readonly 
              style="
                border-radius: 8px;
                border: 1px solid #ced4da;
                background-color: #e9ecef;
                color: #495057;
                cursor: not-allowed;
                resize: none;
              ">
              {{ entrega.nombre_completo | default('') }} - {{ entrega.domicilio | default('') }} - Tel√©fono: {{ entrega.telefono | default('') }} - {{ entrega.municipio | default('') }}, {{ entrega.departamento | default('') }}
            </textarea>
          </div>

          <!-- Botones de Acci√≥n -->
          <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary btn-lg" style="
              border-radius: 10px;
              padding: 12px 30px;
              background: linear-gradient(135deg, #6a11cb, #2575fc);
              border: none;
              color: white;
              font-weight: 600;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              transition: all 0.3s ease;
            ">
              <i class="bi bi-save me-2" style="font-size: 1.2rem;"></i>Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  function validarCostoDomicilio(input) {
    let value = input.value;

    // Permitir solo n√∫meros y un punto decimal (formato: 1234567890.12)
    const regex = /^\d*\.?\d*$/;
    if (!regex.test(value)) {
      input.value = value.replace(/[^0-9.]/g, ''); // Eliminar caracteres no permitidos
      value = input.value;
    }

    // Asegurar que solo haya un punto decimal
    const decimalCount = (value.match(/\./g) || []).length;
    if (decimalCount > 1) {
      input.value = value.substring(0, value.lastIndexOf('.'));
      value = input.value;
    }

    // Dividir el valor en parte entera y decimal (si existe)
    const parts = value.split('.');
    const parteEntera = parts[0];
    let parteDecimal = parts[1] || '';

    // Limitar la parte entera a 10 d√≠gitos
    if (parteEntera.length > 10) {
      input.value = parteEntera.substring(0, 10) + (parteDecimal ? '.' + parteDecimal : '');
      value = input.value;
      return;
    }

    // Limitar la parte decimal a 2 d√≠gitos
    if (parteDecimal.length > 2) {
      input.value = parteEntera + '.' + parteDecimal.substring(0, 2);
      value = input.value;
      return;
    }

    // Limitar el total a 13 caracteres (10 d√≠gitos + 1 punto + 2 decimales)
    if (value.length > 13) {
      input.value = value.substring(0, 13);
      value = input.value;
      return;
    }

    // Validar que no sea un n√∫mero negativo
    if (value && parseFloat(value) < 0) {
      input.value = '';
      value = input.value;
      return;
    }
  }

  function validarFormulario() {
    const costoDomicilio = document.getElementById('costo_domicilio');
    validarCostoDomicilio(costoDomicilio);
    return true; // Permitimos el env√≠o porque las validaciones ya est√°n hechas en tiempo real
  }
</script>

{% endblock %}